###########################################################################
# LPRng - An Extended Print Spooler System
#
# Copyright 1988-1997 Patrick Powell, San Diego, California
#     papowell@sdsu.edu
# See license.txt for conditions of use.
#
# Heavily modified 2006 by Bernhard R. Link
#
########################################################################## 

# Reference Makefile

FMT=LPRng-Reference
DOC=LPRng-Reference

SRC=@SRCDIR@
JADE=@JADE@
JADETEX=@JADETEX@

# if not in your standard sgml search path, something like:
#      -c /usr/local/share/sgml/catalog \
#      -c /usr/local/share/sgml/docbook/dsssl/modular/catalog
CATALOGS=@CATALOGS@

#DOCBOOKDSSSL=/usr/local/share/sgml/docbook/dsssl
DOCBOOKDSSSL=@DOCBOOK@

all: $(REFERENCED) $(DOC).html $(DOC).pdf 
#  LPRng-Reference-Multipart/index.htm

REFERENCED = license.txt
INCLUDED = license.enc y2k.txt
NEEDED = $(INCLUDED) $(FMT).dsl genindex.sgml
DISTFILES = license.txt y2k.txt $(DOC).sgml

MOSTLYCLEANFILES = *.errs HTML.* \
		   *.tex *.log *.aux *.toc *.dvi *.ps \
		   genindex.sgml license.enc
CLEANFILES = $(MOSTLYCLEANFILES) *.htm *.html *.pdf LPRng-Reference-Multipart

license.enc: license.txt Makefile
	echo "<![ CDATA [" >$@
	cat license.txt >>$@
	echo "]]>" >>$@

genindex.sgml: $(DOC).sgml $(INCLUDED)
	-rm -f genindex.sgml
	perl collateindex.pl -t "Index" -N -o genindex.sgml
	$(JADE) -t sgml -V html-index -V nochunks \
		$(CATALOGS) -d $(DOCBOOKDSSSL)/modular/html/docbook.dsl \
		$(DOC).sgml >/dev/null
	perl collateindex.pl -t "Index" -o genindex.sgml HTML.index

$(DOC).html: $(DOC).sgml $(NEEDED)
	$(JADE) -i output.html -V nochunks -t sgml \
		$(CATALOGS) -d $(FMT).dsl $(DOC).sgml > $@
	-tidy -i -m -f /dev/null ${TIDYFLAGS} $@
	perl ./updateheader $@

check: $(INCLUDED)
	nsgmls -s $(CATALOGS) $(DOC).sgml

$(DOC).tex: $(DOC).sgml $(NEEDED)
	$(JADE) -Vtex-backend -ioutput.print -t tex -o $@ \
		$(CATALOGS) -d $(FMT).dsl $(DOC).sgml

$(DOC).dvi: $(DOC).tex
	@echo "==> TeX pass 1/3"
	-$(JADETEX) $(DOC).tex  2>&1 >/dev/null
	@echo "==> TeX pass 2/3"
	-$(JADETEX) $(DOC).tex  2>&1 >/dev/null
	@echo "==> TeX pass 3/3"
	$(JADETEX) $(DOC).tex

$(DOC).ps: $(DOC).dvi
	dvips -q -t letter -o $(DOC).ps $(DOC).dvi

$(DOC).pdf: $(DOC).ps
	ps2pdf -dPDFSETTINGS=/default \
	-dEmbedAllFonts=true \
	-dAntiAliasColorImages=true \
	-dAntiAliasGrayImages=true \
	-dAntiAliasMonoImages=true \
	-dCompatibilityLevel=1.2  \
	$(DOC).ps $(DOC).pdf

purge:
	rm -f *.aux *.log *.toc *.fot *.ps *.dvi *.tex


.PHONY: all mostlyclean distclean clean install update purge correct

update:
	perl ./updatesgmlmirrors ../MIRRORS *.sgml
	perl ./updateversion *.sgml
	${MAKE} all

install:
	
mostlyclean:
	-rm -f $(MOSTLYCLEANFILES)

clean: mostlyclean
	-rm -f $(CLEANFILES)

distclean: clean
	-rm Makefile

correct:
	correct -d dict *.sgml

LPRng-Reference-Multipart/index.htm: $(DOC).sgml $(DOC).dsl Makefile license.enc
	rm -rf LPRng-Reference-Multipart;
	if [ ! -d LPRng-Reference-Multipart ] ; then mkdir LPRng-Reference-Multipart; fi
	cp LPRng.jpg LPRngT-L.jpg LPRng-Reference-Multipart
	$(JADE) -i output.html -V html-manifest -t sgml \
		$(CATALOGS) -d $(FMT).dsl $(DOC).sgml
	-tidy -i -m -f /dev/null ${TIDYFLAGS} `xargs < HTML.manifest`
	perl ./updateheader index.htm
	mv *.htm LPRng-Reference-Multipart
